<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8">
<title>Sample_GoogleMap</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="js/exif.js"></script>
<script src="js/myfunctions.js"></script>
<!-- <script src="http://maps.google.com/maps/api/js?key=AIzaSyATtoz2AIUgVgN5vNzgYbzyNQLdrjwFJ6E&language=ja"></script> -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATtoz2AIUgVgN5vNzgYbzyNQLdrjwFJ6E&callback=initMap" async defer></script>


<style>
html { height: 100% }
body { height: 100% }
#map { height: 100%; width: 100%}
</style>
</head>

<body>
    <section>

        <form action="php/file_up.php" enctype="multipart/form-data" method="post"><input name="file_input" type="file" id="upFile"> <input type="submit" value="アップロード" id="upload"></form>

        <div>
            <input type="button" id="test" value="実行" />

        </div>
        <div id="result"></div>
    </section>

    <div id="map"></div>

<script>

// initialted at reload
let files = document.getElementById("upFile");
let tmpKey = "tmpFilePath"
let pathKey = "filePath"
$(function(){
    // get the list of localstrage key
    let keys = [];
    for(let i = 0; i <localStorage.length; i++){
        keys[i] = localStorage.key(i);
    };
    

    // check
     
    if(keys.includes(tmpKey) && keys.includes(pathKey)){
        if("../" + localStorage.getItem(tmpKey)==localStorage.getItem(pathKey)){
            // localStorage.getItem(tmpKey);

            // EXIF.getDataでexif情報を解析
            EXIF.getData(localStorage.getItem(tmpKey), function() {
                let lat = '';
                let lng = '';
                lat += EXIF.getTag(this, "GPSLatitude");
                lng += EXIF.getTag(this, "GPSLongitude");
                lat = lat.split(",").map(x => Number(x));
                lng = lng.split(",").map(x => Number(x));
                let location = [cnvrtDecimal(lat[0], lat[1], lat[2])[1], cnvrtDecimal(lng[0], lng[1], lng[2])[1]];
                console.log(location)

                // plot the location in google map 
                latLng = new google.maps.LatLng(location[0], location[1]);
                Options = {
                    zoom: 15,      //地図の縮尺値
                    center: latLng,    //地図の中心座標
                    mapTypeId: 'roadmap'   //地図の種類
                };
                map = new google.maps.Map(document.getElementById('map'), Options);
                let marker = new google.maps.Marker({ // マーカーの追加
                    position: latLng, // マーカーを立てる位置を指定
                    map: map // マーカーを立てる地図を指定
                    });
                
                let infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
                        content: '<div class="sample">TAM 大阪</div>' // 吹き出しに表示する内容
                    });
                marker.addListener('click', function() { // マーカーをクリックしたとき
                    infoWindow.open(map, marker); // 吹き出しの表示
                    });
            });



        }else{
            alert("画像ファイルが見つかりません");
        };
    };
})

//
$("#upload").on("click", function(){
    files = document.getElementById("upFile");
    localStorage.setItem(tmpKey, `img/${files.files[0].name}`)
    console.log(files.files[0].name);
    $("#result").html(`<img src="img/${files.files[0].name}" alt="" width="500" height="600">`)
})




// initial map
function initMap(){
    var latLng = new google.maps.LatLng(35.6811673, 139.7670516);
    var Options = {
    zoom: 15,      //地図の縮尺値
    center: latLng,    //地図の中心座標
    mapTypeId: 'roadmap'   //地図の種類
    };
    var map = new google.maps.Map(document.getElementById('map'), Options);
}

// photo
$(function() {
        $('#test').on('click', function() {
            let file_input = $('#upFile');
            const file = file_input[0].files[0];
            console.log(file.name )
            
            // EXIF.getDataでexif情報を解析
            EXIF.getData(file, function() {
                let lat = '';
                let lng = '';
                lat += EXIF.getTag(this, "GPSLatitude");
                lng += EXIF.getTag(this, "GPSLongitude");
                lat = lat.split(",").map(x => Number(x));
                lng = lng.split(",").map(x => Number(x));
                let location = [cnvrtDecimal(lat[0], lat[1], lat[2])[1], cnvrtDecimal(lng[0], lng[1], lng[2])[1]];
                console.log(location)

                // plot the location in google map 
                latLng = new google.maps.LatLng(location[0], location[1]);
                Options = {
                    zoom: 15,      //地図の縮尺値
                    center: latLng,    //地図の中心座標
                    mapTypeId: 'roadmap'   //地図の種類
                };
                map = new google.maps.Map(document.getElementById('map'), Options);
                let marker = new google.maps.Marker({ // マーカーの追加
                    position: latLng, // マーカーを立てる位置を指定
                    map: map // マーカーを立てる地図を指定
                    });
                
                let infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
                        content: '<div class="sample">TAM 大阪</div>' // 吹き出しに表示する内容
                    });
                marker.addListener('click', function() { // マーカーをクリックしたとき
                    infoWindow.open(map, marker); // 吹き出しの表示
                    });
            });

            

        });
    });



</script>

</body>
</html>